---
title: A geo-referenced micro-data set of real estate listings for the three largest Spanish cities
runninghead: Rey-Blanco \emph{et al}.
author:
- name: D. Rey-Blanco
  num: 1
- name: P. González-Arbues
  num: 1
- name: F. López
  num: 2
- name: A. Páez*
  num: 4
address:
- num: 1
  org: Idealista, Plaza de las Cortes 5, 28014 Madrid, Spain
- num: 2
  org: Facultad de CC de la Empresa, C/ Real, 3. 30201 Cartagena, Murcia, Spain
- num: 3
  org: School of Earth, Environment and Society, McMaster University, 1280 Main St W, Hamilton, Ontario L8S 4K1 Canada
corrauth: "Antonio Páez, School of Earth, Environment and Society, McMaster University, 1280 Main St W, Hamilton, Ontario L8S 4K1 Canada."
email: paezha@mcmaster.ca
abstract: "This data article shares an open data product with big geo-referenced micro-data sets of 2018 real estate listings in Spain. These data were originally published on idealista.com real estate website. The observations are obtained for the three largest Spanish cities: Madrid (n = 94,815 observations), Barcelona (n = 61,486 observations) and Valencia (n = 33,622 observations). The data sets include the coordinates of properties (latitude and longitude), asking prices of each listed dwelling, and several variables of indoor characteristics. The listings were enriched with official information (building year of construction and built quality materials grade) plus other relevant geographical features such as distance to urban points of interest. Along with real estate listings, the data product also includes neighborhood boundaries for each city. The data product is offered in the form of a fully documented R package. This open data product is available for scientific and educational purposes, in particular for geo-spatial studies."
keywords: Housing market; idealista.com; geo-referenced data; open data; hedonic price analysis; Spain
classoption:
  - Royal
  - times
bibliography: bibEPB.bib
bibliographystyle: sageh

output:
  rticles::sage_article:
    keep_tex: yes


    
header-includes:
  - \usepackage[linesnumbered,lined,boxed,commentsnumbered]{algorithm2e}
---

# Introduction

El interés pos el desarrollo de modelos hedónicos de preicción del precio de lvivienda que incluyen la compenente espaciál,  y en general de la importancia de la geografía para realizar un correcto analisis del mercado inmobiliario, ha siod un tópico de creciente interes [@lopez2015; @crespo2013local].

Por otra parte la posibilidad de disponer de datos a nivel micro/urbano de la vivienda ha sido dificil y en algunos casso se ha tenido que recurrir a dudosos procesos de webscraping para poder obtener grandes volúmnees de informacion que permitan. En muchos casos estos procesos de webscrappin pueden contener datos faltantes, errores, datos duplicados etc,

El creciente interés por datos en abierto [@arribas2021]

The main objective of this paper is present a sort description of the an open data set of a geo-referenced dwelling listings.

This data set is excelente para aplicar modelos hedónicos con efectos espaciales, identificar submercados de vivienda, aplicar técnicas de machine learning.

La importancia de disponer de datos en abierto

Pocos datos en abierto de precios de vivienda

Pocos con informacion georeferenciada a nivel de punto

The data set is distributed in the form of an `R` package, named **idealista18** available from https://github.com/paezha/idealista18 . All spatial objects such as polygons and points are distributed as simple features objects (class `sf` in R). The data has been provided by Idealista, the major real estate listing website in Spain, and present in other southern european countries as Italy and Portugal.

POR QUE HACEN UNA CONTRIBUCIÓN A LA COMUNIDAD URBAN ANALITICS

# Data description

The open data set 'idealista18' is composed of nine objects, three objects for each of the three main Spanish cities: Barcelona, Madrid and Valencia. For each city, dwelling listings, neighborhood polygons and a set of points of interest (POI) has been included in the R package. The next subsections describe each data set.

## Dwelling listings

The dwelling listing of each city, include a set of characteristics of each dwelling that was published on idealista real state website (https://www.idealista.com/) and are included in 'idealista18' package as an sf object [@Pebesma]. The data set corresponding to each city is named with the name of the city followed by '_Sale'. Each of these files contains the complete set of listings, corresponding to the four quarters of year 2018. The record counts for each city in 2018 are: 94,815 listings for Madrid, 61,486 for Barcelona and 33,622 for Valencia. Table \ref{tab:number-ads} show the number of ads included in the data set for city and quarter. Note that is possible that the same dwelling can be found in more than one period when a property listed for sale in one quarter was sold in a subsequent quarter. The variable ASSETID, included in each sf object is the unique identifier of the dwelling.

```{r number-ads, echo = FALSE, message = FALSE}
library(idealista18)
library(kableExtra)
library(xtable)
library(sf)
H <- t(cbind(table(Barcelona_Sale$PERIOD),table(Madrid_Sale$PERIOD),table(Valencia_Sale$PERIOD)))
H <- cbind(H,rowSums(H))
text_tbl <- data.frame(
City = c("Barcelona","Madrid","Valencia"),
H,
check.names = FALSE)
colnames(text_tbl) <- c("City", "First", "Second ", "Thirdr", "Fourth","Total ads")
xtable::xtable(text_tbl, digits=0, caption = "Number of dwelling  listing ads for each city and quarter. \\label{tab:number-ads}") %>%
xtable2kable(include.rownames = FALSE) %>%
kable_styling(full_width = F) %>%
column_spec(1, width = "4em", italic = FALSE) %>%
column_spec(2, width = "3em") %>%
column_spec(3, width = "3em", latex_column_spec = "c") %>%
column_spec(4, width = "3em", latex_column_spec = "c") %>%
column_spec(5, width = "3em", latex_column_spec = "c") %>%
column_spec(6, width = "2em", latex_column_spec = "c")
```

Each record of the dwelling listing contains a set of indoor characteristics supplied by advertiser (e.g. price, surface, rooms, basic features, etc) beside with the exact localization of the dwelling (see Section \ref{sec:anonymizing}). Table \ref{tab:variables} list some of the main indoor variables included in the dwelling listing with a short description and the mean value of each variable. This dwelling listing was enriched with a number of additional attributes from the Spanish cadastre [@Catastro]. Cadastral information is described in Table \ref{tab:variables}, including the the prefix CAD in the variable name. Cadastral features assignment is done by assigning the features of the nearest parcel to the coordinates. The year of construction of dwelling was revised, given that original year of construction from listings are entered by users in the web site, therefore subject to errors and incomplete (a 40\% missing rate). To remove any issue we assign cadastral construction year from the nearest cadastral parcel whenever value has an outstanding value (date is after publication date or year of construction is before 1500) or when the field value was missing. Additionally, the distance of each dwelling to three urban points of interest was included in the data set: distance to city center, distance to the closed metro station and distance to the main street (Diagonal street for Barcelona, Castellana street for Madrid and Blasco Ibañez street for Valencia). The last rows of Table \ref{tab:variables} show the mean values of this variables.

```{r table-variables, echo = FALSE, message = FALSE}
library(idealista18)
library(kableExtra)
library(xtable)
library(sf)
dummyvariables <- c(3,4,5,6,7,27,30,31,32,33,37,38,39)
text_tbl <- data.frame(
Variable = names(st_drop_geometry(Barcelona_Sale[dummyvariables])),
"Sort Description" = c("ksjdhfal","Asking price per m^2 (euros)","Surface (m^2)",
                       "Number of bedrooms","Number of bathrooms",
                       "Construction year (advertiser)","Construction year (cadastre)",
                       "Max build floor","Dwelling count in the building",
                       "Cadastral quality. 0 Best-10 Worst",
                       "Distance to city center","Distance to subway station","Distance to main street"),
# Barcelona
Barcelona = colMeans(st_drop_geometry(Barcelona_Sale[dummyvariables]), na.rm = TRUE),
# Madrid
Madrid = colMeans(st_drop_geometry(Madrid_Sale[dummyvariables]), na.rm = TRUE),
# Valencia
"Valencia"=colMeans(st_drop_geometry(Valencia_Sale[dummyvariables]), na.rm = TRUE),
check.names = FALSE)

xtable::xtable(text_tbl, caption = "List of quantitative variables included in the dwelling listing for the three Spanish cities. See the help facility in the \\textbf{idealista18} R package for details and formal definitions. Some variables has been excluded of this table for save space, check the full list in  \\textbf{idealista18} R package. \\label{tab:variables}") %>%
xtable2kable(include.rownames = FALSE) %>%
kable_styling(full_width = F, font_size=8) %>%
column_spec(1, width = "13em", italic = FALSE) %>%
column_spec(2, width = "14em") %>%
column_spec(3, width = "2em", latex_column_spec = "c") %>%
column_spec(4, width = "2em", latex_column_spec = "c") %>%
column_spec(5, width = "2em", latex_column_spec = "c")
```

To conclude the description of the dwelling listing, Table \ref{tab:Dummy-variables} include the more relevant variables that include information about basic characteristics of the dwellings. All variables listed in this table are dummy variables and the percentaje of dwelling with the characteristis

```{r table-dummy-variables, echo = FALSE, message = FALSE}
library(idealista18)
library(kableExtra)
library(xtable)
library(sf)
dummyvariables <- c(8,9,10,12,15,16,17,18,19,20,21,22,23,24,25,26,34,35,36)
text_tbl <- data.frame(
Variable = names(st_drop_geometry(Barcelona_Sale[dummyvariables])),
"Sort Description" = c("=1 if has terrace","=1 if has lift",
                       "=1 if has air conditioning","=1 if has parking",
                       "=1 if has north orientation","=1 if has south orientation",
                       "=1 if has east orientation","=1 if has west orientation",
                       "=1 if has boxroom","=1 if has wardrobe",
                       "=1 if has swinningpool","=1 if has doorman",
                       "=1 if has garden","=1 if is duplex",
                       "=1 if is studio","=1 is in the top floor",
                       "=1 if is new","=1 is second hand to be restored","=1 is second hand good conditions"),
# Barcelona
Barcelona = colMeans(st_drop_geometry(Barcelona_Sale[dummyvariables])),
# Madrid
Madrid = colMeans(st_drop_geometry(Madrid_Sale[dummyvariables])),
# Valencia
"Valencia"=colMeans(st_drop_geometry(Valencia_Sale[dummyvariables])),
check.names = FALSE)

xtable::xtable(text_tbl, caption = "List of dummy variables with the percentage of dwelling with a specific characteristic. See the help facility in the \\textbf{idealista18} R package for details and formal definitions. Some dummy variables has been excluded of this table for save space. \\label{tab:Dummy-variables}") %>%
xtable2kable(include.rownames = FALSE) %>%
kable_styling(full_width = F, font_size = 8) %>%
column_spec(1, width = "12em", italic = FALSE) %>%
column_spec(2, width = "14em") %>%
column_spec(3, width = "2em", latex_column_spec = "c") %>%
column_spec(4, width = "2em", latex_column_spec = "c") %>%
column_spec(5, width = "2em", latex_column_spec = "c")
```

## Neighboorhood polygons

The second block of data included in the 'idealista18' R package are the spatial features of the three cities divided in neighborhoods. Figure \ref{fig:all-polygons} shows the different neighborhoods for the three cities. The boundaries are based on the official boundaries but slightly adapted by idealista\footnote{The criterion used to adapt this division is double, if an area is small enough and similar enough to another they merge both areas, on the other hand if the official area is not homogeneous it is then divided in a series of new polygons}. In practical terms we can assume they are the same, since the website simply collapses areas when they are sufficiently small in terms of number of ads. In the case of Madrid they just collapse four areas into two new ones.

A total of 

```{r, echo = FALSE, fig.width=5, fig.cap="\\label{fig:all-polygons} (A) Weekly intra-province"}
library(ggplot2)
library(gridExtra)
plot1 <- ggplot(data=Barcelona_Polygons) + geom_sf(color = "black",size=.2) + 
  theme_bw(base_size = 2) + 
  ggtitle("                Barcelona") +
  theme(plot.title = element_text(size = 10),
        panel.border = element_blank(),
    axis.text = element_blank(),panel.grid = element_blank(), axis.ticks = element_blank())
plot2 <- ggplot(data=Madrid_Polygons) + geom_sf(color = "black",size=.2) + 
  theme_bw(base_size = 2) +
   ggtitle("                Madrid") +
    theme(plot.title = element_text(size = 10),panel.border = element_blank(),
    axis.text = element_blank(),panel.grid = element_blank(), axis.ticks = element_blank())
plot3 <- ggplot(data=Valencia_Polygons) + geom_sf(color = "black",size=.2) + 
  theme_bw(base_size = 2) +
   ggtitle("                Valencia") +
    theme(plot.title = element_text(size = 10),panel.border = element_blank(),
    axis.text = element_blank(),panel.grid = element_blank(), axis.ticks = element_blank())
grid.arrange(plot1, plot2, plot3, ncol = 3, nrow = 1)
```

There are a total of 73 neigborhoods in Barcelona, 135 in Madrid and 73 in Valencia. The sf object include an unique identifier (LOCATIONID) and the neighborhood name (LOCATIONNAME).

## Points of Interest

The last block of data included in the data package is a set of Point of Interest of each city in `R` list R objetc. These lists include three elements: (i) the coordinates of the city center (see that identify the central business district); (ii) a set of points that define the main street of each city; and (iii) the coordinates of metro stations.

# Anonymizing the data set {#sec:anonymizing}

To comply with Spanish regulations, two variables are slightly modified to preserve their anonymity. A masking process is apply to asking prices and localization. 

Whit respect to the asking prices, the original values are obfuscated with the addition or subtraction of a random percentage of their original values ranging from -2.5\% to +2.5\%. Since asking prices are usually multiples of 1000, after the first price modification, the prices was aligned to multiples of 1000. 

With respect to the dwelling localization, a spatial masking process was implemented with the intention of keeping spatial properties of the original data set. The coordinates of each listing were displaced using a stochastic procedure. Effectively, the listings were recorded using coordinates contained in a maximum and minimum displacement circles, as shown in Figure \ref{fig:points-moved-image}. To preserve membership in a neighborhood, the spatial masking procedure was constrained to ensure that the masked coordinates are in the original neighborhood of the listing.


```{=tex}
\begin{figure}[!ht]
  \caption{Masking coordinates. Spatial range}
  \centering
  \includegraphics[width=6cm, height=4.9cm]{EPB_files/points-moved-image.png}
  \label{fig:points-moved-image}
\end{figure}
```

The algorithm \ref{algo:coordinates-displacement} iteratively displaces the coordinates of each listing with a minimum distance and a maximum distance with the restriction that the new coordinates do not fall in a different neighborhood. This ensures that neighborhood attributes are preserved.

```{=tex}
\begin{algorithm}[!ht]
 \KwData{all idealista listings}
 \KwResult{all idealista listings with masked coordinates}
 initialization\;
 \For{each listing L}{
  take geographical location of L as $(X,Y)$
  \Repeat{this stop condition}{
    take a random angle $\alpha$ from 0 to 360 degrees
    take a distance $R$ as a random value from 30 to 60 meters
    determine a new point $(X',Y')$ calculated as a point located $R$ with the angle $\alpha$
  }
  set $(X',Y')$ as the new location for the listing L
 }
 \caption{Coordinate displacement process for anonymisation purposes}
 \label{algo:coordinates-displacement}
\end{algorithm}
```

Figure \ref{fig:coordinates-displacement} shows the histogram of displacements in meters for all listings in the city of Valencia; the average distance between the original and masked coordinates is 45 meters.

```{=tex}
\begin{figure}[!ht]
  \caption{Masking coordinates. Spatial range}
  \centering
  \includegraphics[width=6cm, height=4.9cm]{EPB_files/coordinates-valencia.png}
  \label{fig:points-moved-image}
\end{figure}
```

## The geo-referenced micro-data set

Spatial objects include geodetic coordinates using the \emph{EPSG:4326} coordinate reference system.

# Acknowledgments

The authors wish to thank Alessandro Galesi for their support in the paper revision and Juan Ramon Selva for collecting and cleaning the spatial data. This work has been partially funded by the Spanish Ministry of Economy and Competitiveness Grants PID2019-107800GB- 100

