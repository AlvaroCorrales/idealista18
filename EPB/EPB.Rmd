---
title: A geo-referenced micro-data set of real estate listings for the three largest Spanish cities
runninghead: Rey-Blanco \emph{et al}.
author:
- name: D. Rey-Blanco
  num: 1
- name: P. González-Arbues
  num: 1
- name: F. López
  num: 2
- name: A. Páez*
  num: 4
address:
- num: 1
  org: Idealista, Plaza de las Cortes 5, 28014 Madrid, Spain
- num: 2
  org: Facultad de CC de la Empresa, C/ Real, 3. 30201 Cartagena, Murcia, Spain
- num: 3
  org: School of Earth, Environment and Society, McMaster University, 1280 Main St W, Hamilton, Ontario L8S 4K1 Canada
corrauth: "Antonio Páez, School of Earth, Environment and Society, McMaster University, 1280 Main St W, Hamilton, Ontario L8S 4K1 Canada."
email: paezha@mcmaster.ca
abstract: "This data article shares an open data product with big geo-referenced micro-data sets of 2018 real estate listings in Spain. These data were originally published on idealista.com real estate website. The observations are obtained for the three largest Spanish cities: Madrid (n = 94,815 observations), Barcelona (n = 61,486 observations) and Valencia (n = 33,622 observations). The data sets include the coordinates of properties (latitude and longitude), asking prices of each listed dwelling, and several variables of indoor characteristics. The listings were enriched with official information from the Spanish cadastre (e.g. built quality materials grade) plus other relevant geographical features such as distance to urban points of interest. Along with real estate listings, the data product also includes neighborhood boundaries for each city. The data product is offered in the form of a fully documented R package. This open data product is available for scientific and educational purposes, in particular for geo-spatial studies."
keywords: Housing market; idealista.com; geo-referenced data; point level data; open data; hedonic price analysis; Spain
classoption:
  - Royal
  - times
bibliography: bibEPB.bib
bibliographystyle: sageh

output:
  rticles::sage_article:
    keep_tex: yes


    
header-includes:
  - \usepackage[linesnumbered,lined,boxed,commentsnumbered]{algorithm2e}
---

# Introduction

The interest about the determinants of housing market and housing prices has been a growing research area in the last decades, with a vast literature both theoretical as well as empirical. Include the spatial component to analyze the real state market, and in general the incorporate geographic variables, has been significant improvements in the understanding of this market. But to really understand the determinants of housing market it is essential to have information/data at level-point. Therefore, it is increasingly common that the spatial analysis to be development in urban environment with geo-referenced micro-data sets [e.g. @lopez2015; @crespo2013local]. But on the other hand, the availability of this type of open data at point level is limited and not to much data set contain latitude/longitude coordinates of each dwelling. In some cases the researchers it has had to resort to web scraping processes in order to obtain large volumes of information that allow get robust analysis [@gupta2022take; @arbia2020spatial; @Li2019; @lopez2015]. These web scraping processes can include a lot of missing data, download errors, duplicate records, etc. Furthermore, in general the authors of this researches do not share the data sets.

In the same vein, in the last years there are a growing interest in open data in geography and data science [@arribasl2021editorial; @arribas2021] and in general by the reproducible or replicable research [@paez2021open]. But to make open science is necessary have free software and open data. While great efforts have been made to make free software available to researchers (e.g. R or Python), not much data is out in the open. In the particular case of the real estate market, to our knowledge, no to much open micro-data set of housing markets are available.

To overcome these limitations, this paper present a sort description of the an open micro-data set of a geo-referenced dwelling listings. The data has been provided by Idealista company\footnote{Idealista is the major real estate listing website in Spain, and present in other southern european countries as Italy and Portugal} and contain information of 189,923 dwelling localized in the three major Spanish cities. To the date, this data product is the bigger open geo-referenced data set of housing market in Spain. Moreover, note that the data set is supply directly by Idealista and therefore is clean and free of download errors. The listings has been enriched with official information from the Spanish cadastre plus other relevant geographical features such as distance to urban points of interest. The data set is distributed in the form of an `R` package, named **idealista18** that can be accessed at Github repository\footnote{The direct URL to the Github repository is https://github.com/paezha/idealista18}. 

<!-- @cohen2008spatial (508 observations) -->
<!-- @lazrak2014market (19000 observations) -->

# Data description

The open data set 'idealista18' is R package composed of nine objects, three objects for each of the three main Spanish cities: Barcelona, Madrid and Valencia. For each city, dwelling listings, neighborhood polygons and a set of points of interest (POI) has been included in the R package. The next subsections describe each object. A full description of the data is available in the helps of the package.

## Dwelling listings

The dwelling listing of each city, include a set of characteristics of each dwelling that was published on idealista real state website (https://www.idealista.com/) and are included in 'idealista18' package as an sf object [@Pebesma]. The data set corresponding to each city is named with the name of the city followed by '_Sale' (e.g. Madrid_Sale) and include a total of 42 variables. Each sf objects contains the complete set of listings, corresponding to the four quarters of year 2018. The record counts for each city in 2018 are: 94,815 listings for Madrid, 61,486 for Barcelona and 33,622 for Valencia. Table \ref{tab:number-ads} show the number of dwelling listing ads included in the data set for city and quarter. Note that is possible that the same dwelling can be found in more than one period when a property listed for sale in one quarter was sold in a subsequent quarter. The variable ASSETID, included in the sf objects is the unique identifier of the dwelling.

```{r number-ads, echo = FALSE, message = FALSE}
library(idealista18)
library(kableExtra)
library(xtable)
library(sf)
H <- t(cbind(table(Barcelona_Sale$PERIOD),table(Madrid_Sale$PERIOD),table(Valencia_Sale$PERIOD)))
H <- cbind(H,rowSums(H))
text_tbl <- data.frame(
City = c("Barcelona","Madrid","Valencia"),
H,
check.names = FALSE)
colnames(text_tbl) <- c("City", "First", "Second ", "Thirdr", "Fourth","Total ads")
xtable::xtable(text_tbl, digits=0, caption = "Number of dwelling  listing ads for each city and quarter. \\label{tab:number-ads}") %>%
xtable2kable(include.rownames = FALSE) %>%
kable_styling(full_width = F) %>%
column_spec(1, width = "4em", italic = FALSE) %>%
column_spec(2, width = "3em") %>%
column_spec(3, width = "3em", latex_column_spec = "c") %>%
column_spec(4, width = "3em", latex_column_spec = "c") %>%
column_spec(5, width = "3em", latex_column_spec = "c") %>%
column_spec(6, width = "2em", latex_column_spec = "c")
```

Each record of the dwelling listing contains a set of indoor characteristics supplied by advertiser in the Idealista web (e.g. price, surface, rooms, basic features, etc) including the exact localization of the dwelling (see Section [Anonymizing the data set](#anonymizing)). Table \ref{tab:variables} list some of the main indoor variables included in the dwelling listing with a short description and the mean value of each variable. This dwelling listing was enriched with a number of additional attributes from the Spanish cadastre [@Catastro]. Cadastral information is described in Table \ref{tab:variables}, including the the prefix CAD in the variable name. Cadastral features assignment is done by assigning the features of the nearest parcel to the coordinates. The year of construction of dwelling (CONSTRUCTIONYEAR) supply by the advertiser was revised given that the year of construction are entered by users in the web site and therefore subject to errors and incomplete data (a 40\% missing rate). To solve this issue we include an alternative variable (CADCONSTRUCTIONYEAR) assign cadastral construction year from the nearest cadastral parcel whenever value has an outstanding value (date is after publication date or year of construction is before 1500) or when the value supply by the advertiser was missing. Additionally, the distance of each dwelling to three urban points of interest was included in the dwelling listing: distance to city center, distance to the closed metro station and distance to the main street (Diagonal street for Barcelona, Castellana street for Madrid and Blasco Ibañez street for Valencia). The last rows of Table \ref{tab:variables} show the mean values of this variables.

```{r table-variables, echo = FALSE, message = FALSE}
library(idealista18)
library(kableExtra)
library(xtable)
library(sf)
dummyvariables <- c(3,4,5,6,7,27,30,31,32,33,37,38,39)
text_tbl <- data.frame(
Variable = names(st_drop_geometry(Barcelona_Sale[dummyvariables])),
"Sort Description" = c("Asking price","Asking price per m^2 (euros)","Surface (m^2)",
                       "Number of bedrooms","Number of bathrooms",
                       "Construction year (advertiser)","Construction year (cadastre)",
                       "Max build floor","Dwelling count in the building",
                       "Cadastral quality. 0 Best-10 Worst",
                       "Distance to city center","Distance to subway station","Distance to main street"),
# Barcelona
Barcelona = colMeans(st_drop_geometry(Barcelona_Sale[dummyvariables]), na.rm = TRUE),
# Madrid
Madrid = colMeans(st_drop_geometry(Madrid_Sale[dummyvariables]), na.rm = TRUE),
# Valencia
"Valencia"=colMeans(st_drop_geometry(Valencia_Sale[dummyvariables]), na.rm = TRUE),
check.names = FALSE)
text_tbl[dim(text_tbl)[1],1]<-"DISTANCE_TO_(MAINSTREET)"
xtable::xtable(text_tbl, caption = "List, sort description and mean of the main quantitative variables included in the dwelling listing for the three Spanish cities. See the help facility in the \\textbf{idealista18} R package for details and formal definitions. Some variables has been excluded of this table for save space, check the full list in  \\textbf{idealista18} R package. \\label{tab:variables}") %>%
xtable2kable(include.rownames = FALSE) %>%
kable_styling(full_width = F, font_size=8) %>%
column_spec(1, width = "13em", italic = FALSE) %>%
column_spec(2, width = "14em") %>%
column_spec(3, width = "2em", latex_column_spec = "c") %>%
column_spec(4, width = "2em", latex_column_spec = "c") %>%
column_spec(5, width = "2em", latex_column_spec = "c")
```

In addition to the variables listed in Table \ref{tab:variables} the sf object include a set of dummy variables with information abour basic characteristics of the dwelling. Table \ref{tab:Dummy-variables} show the more relevant variables included in the sf object.

```{r table-dummy-variables, echo = FALSE, message = FALSE}
library(idealista18)
library(kableExtra)
library(xtable)
library(sf)
dummyvariables <- c(8,9,10,12,15,16,17,18,19,20,21,22,23,24,25,26,34,35,36)
text_tbl <- data.frame(
Variable = names(st_drop_geometry(Barcelona_Sale[dummyvariables])),
"Sort Description" = c("=1 if has terrace","=1 if has lift",
                       "=1 if has air conditioning","=1 if has parking",
                       "=1 if has north orientation","=1 if has south orientation",
                       "=1 if has east orientation","=1 if has west orientation",
                       "=1 if has boxroom","=1 if has wardrobe",
                       "=1 if has swinningpool","=1 if has doorman",
                       "=1 if has garden","=1 if is duplex",
                       "=1 if is studio","=1 is in the top floor",
                       "=1 if is new contruction","=1 is second hand to be restored","=1 is second hand good conditions"),
# Barcelona
Barcelona = colMeans(st_drop_geometry(Barcelona_Sale[dummyvariables])),
# Madrid
Madrid = colMeans(st_drop_geometry(Madrid_Sale[dummyvariables])),
# Valencia
"Valencia"=colMeans(st_drop_geometry(Valencia_Sale[dummyvariables])),
check.names = FALSE)

xtable::xtable(text_tbl, caption = "List of dummy variables, sort description and ratio of dwelling with the specific characteristic. See the help facility in the \\textbf{idealista18} R package for details and formal definitions. Some dummy variables has been excluded of this table for save space. \\label{tab:Dummy-variables}") %>%
xtable2kable(include.rownames = FALSE) %>%
kable_styling(full_width = F, font_size = 8) %>%
column_spec(1, width = "12em", italic = FALSE) %>%
column_spec(2, width = "14em") %>%
column_spec(3, width = "2em", latex_column_spec = "c") %>%
column_spec(4, width = "2em", latex_column_spec = "c") %>%
column_spec(5, width = "2em", latex_column_spec = "c")
```

## Neighboorhood polygons

The second block of data included in the 'idealista18' R package are the spatial features of the three cities divided in neighborhoods. There are an sf object for each city with the name of the city and the suffix '_Polygons' (e.g. Valencia_Polygons). The Figure \ref{fig:all-polygons} shows the quantile maps of the number of dwellings in the listing for the different neighborhoods in the three cities. The neighborhoods are based on the official boundaries but slightly adapted by Idealista\footnote{The criterion used to adapt this division is double, if an area is small enough and similar enough to another they merge both areas, on the other hand if the official area is not homogeneous it is then divided in a series of new polygons}. In practical terms we can assume they are the same, since the website simply collapses areas when they are sufficiently small in terms of number of ads. In the case of Madrid they just collapse four areas into two new ones.

```{r, echo = FALSE,message=FALSE,fig.width=5, fig.cap="\\label{fig:all-polygons}Quantile maps of the number of dwellings in each neighborhood. Boundary for Madrid, Barcelona and Valencia"}

library("ggplot2")
library("dplyr")
library("gridExtra")
# Barcelona
Barcelona_counts <- Barcelona_Polygons %>% 
  mutate(counts = lengths(st_intersects(., Barcelona_Sale)))
q <- quantile(Barcelona_counts$counts)
Barcelona_Polygons$Quantile<- as.factor((Barcelona_counts$counts > q[2]) + (Barcelona_counts$counts > q[3]) +(Barcelona_counts$counts >= q[4]) + 1)
plot4 <- ggplot(data = Barcelona_Polygons) +
  geom_sf(aes(fill = Quantile),color = "black",size=.2) +
  theme_bw(base_size = 6) +
  scale_fill_manual(values=c("#FFFEDE","#FFDFA2", "#FFA93F", "#D5610D"))+
  theme(plot.margin=unit(c(0.1,0.1,0.1,0.1),"cm"),legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),text = element_text(size=4))
# Madrid
Madrid_counts <- Madrid_Polygons %>% 
  mutate(counts = lengths(st_intersects(., Madrid_Sale)))
q <- quantile(Madrid_counts$counts)
Madrid_Polygons$Quantile<- as.factor((Madrid_counts$counts > q[2]) + (Madrid_counts$counts > q[3]) +(Madrid_counts$counts >= q[4]) + 1)
plot5 <- ggplot(data = Madrid_Polygons) +
  geom_sf(aes(fill = Quantile),color = "black",size=.2) +
  theme_bw(base_size = 6) +
  scale_fill_manual(values=c("#FFFEDE","#FFDFA2", "#FFA93F", "#D5610D"))+
  theme(plot.margin=unit(c(0.1,0.1,0.1,0.1),"cm"),legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),text = element_text(size=4))
# Valencia
Valencia_counts <- Valencia_Polygons %>% 
  mutate(counts = lengths(st_intersects(., Valencia_Sale)))
q <- quantile(Valencia_counts$counts)
Valencia_Polygons$Quantile<- as.factor((Valencia_counts$counts > q[2]) + (Valencia_counts$counts > q[3]) +(Valencia_counts$counts >= q[4]) + 1)
plot6 <- ggplot(data = Valencia_Polygons) +
  geom_sf(aes(fill = Quantile),color = "black",size=.2) +
  theme_bw(base_size = 6) +
  scale_fill_manual(values=c("#FFFEDE","#FFDFA2", "#FFA93F", "#D5610D"))+
  theme(plot.margin=unit(c(0.1,0.1,0.1,0.1),"cm"),legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),text = element_text(size=4))
####################
# plot1 <- ggplot(data=Barcelona_Polygons) + geom_sf(color = "black",size=.2) + 
#   theme_bw(base_size = 2) + 
#   ggtitle("                Barcelona") +
#   theme(plot.title = element_text(size = 10),
#         panel.border = element_blank(),
#     axis.text = element_blank(),panel.grid = element_blank(), axis.ticks = element_blank())
# plot2 <- ggplot(data=Madrid_Polygons) + geom_sf(color = "black",size=.2) + 
#   theme_bw(base_size = 2) +
#    ggtitle("                Madrid") +
#     theme(plot.title = element_text(size = 10),panel.border = element_blank(),
#     axis.text = element_blank(),panel.grid = element_blank(), axis.ticks = element_blank())
# plot3 <- ggplot(data=Valencia_Polygons) + geom_sf(color = "black",size=.2) + 
#   theme_bw(base_size = 2) +
#    ggtitle("                Valencia") +
#     theme(plot.title = element_text(size = 10),panel.border = element_blank(),
#     axis.text = element_blank(),panel.grid = element_blank(), axis.ticks = element_blank())
grid.arrange(plot4, plot5, plot6, ncol = 3, nrow = 1)
```

There are a total of 69 neighborhoods in Barcelona, 135 in Madrid and 73 in Valencia. The sf object include an unique identifier (LOCATIONID) and the neighborhood name (LOCATIONNAME).

## Points of Interest

The last block of data included in the data package is a set of Point of Interest of each city in `R` list R object. The name of the list include the name of the city with the suffix '_POIS' (e.g. Barcelona_POIS). These lists include three elements: (i) the coordinates of the city center, identifying the central business district; (ii) a set of points that define the main street of each city; and (iii) the coordinates of metro stations.

# Anonymizing the data set {#anonymizing}

To comply with Spanish regulations, two variables are slightly modified to preserve their anonymity. A masking process is apply to asking prices and localization (coordinates). 

Whit respect to the asking prices, the original values are obfuscated with the addition or subtraction of a random percentage of their original values ranging from -2.5\% to +2.5\%. Since asking prices are usually multiples of 1,000, after the first price modification, the prices was aligned to multiples of 1,000. 


```{=tex}
\begin{algorithm}[!ht]
 \KwData{all idealista listings}
 \KwResult{all idealista listings with masked coordinates}
 initialization\;
 \For{each listing L}{
  take geographical location of L as $(X,Y)$
  \Repeat{this stop condition}{
    take a random angle $\alpha$ from 0 to 360 degrees
    take a distance $R$ as a random value from 30 to 60 meters
    determine a new point $(X',Y')$ calculated as a point located $R$ with the angle $\alpha$
  }
  set $(X',Y')$ as the new location for the listing L
 }
 \caption{Coordinate displacement process for anonymisation purposes}
 \label{algo:coordinates-displacement}
\end{algorithm}
```

With respect to the dwelling localization, a spatial masking process was implemented with the intention of keeping spatial properties of the original data set. The coordinates of each listing were displaced using a stochastic procedure. Effectively, the listings were recorded using coordinates contained in a maximum and minimum displacement circles, as shown in Figure \ref{fig:Anonymizing} (left). To preserve membership in a neighborhood, the spatial masking procedure was constrained to ensure that the masked coordinates are in the original neighborhood of the listing. 

The Algorithm \ref{algo:coordinates-displacement} iteratively displaces the coordinates of each listing with a minimum distance and a maximum distance with the restriction that the new coordinates do not fall in a different neighborhood. This ensures that neighborhood attributes are preserved.

Figure \ref{fig:Anonymizing} (rigth) shows the histogram of displacements in meters for all listings in the city of Valencia; the average distance between the original and masked coordinates is 45 meters.

```{r, echo = FALSE, out.width=c("29%","37%"), out.height="20%",fig.cap="\\label{fig:Anonymizing}(Left) Masking coordinates. Spatial range. (Rigth) Coordinate displacement in meters Valencia",fig.show='hold',fig.align='center'}
knitr::include_graphics(c("EPB_files/points-moved-image.png","EPB_files/coordinates-valencia.png"))
```

## Conclusion

The data set present in this paper is excellent for applying hedonic models with spatial effects, identifying housing submarkets, applying machine learning techniques, etc..

# Declaration of Competing Interest}

Author One and author Two are employed by idealista. They have been granted permission to share the data presented in this article. None of the authors have known competing financial interests or personal relationships which have, or could be perceived to have, influenced the work reported in this article.

# Acknowledgments

The authors wish to thank Alessandro Galesi for their support in the paper revision and Juan Ramon Selva for collecting and cleaning the spatial data. This work has been partially funded by the Spanish Ministry of Economy and Competitiveness Grants PID2019-107800GB- 100

